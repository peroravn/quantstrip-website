<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quantstrip - Article Page</title>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">

  <!-- PrismJS core + Python language -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      /* font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; */
      font-family: -apple-system, BlinkMacSystemFont, 'Lato', sans-serif;
      background-color: #f5f5f5;
      color: #1a1a1a;
    }

    h1, h2, h3, h4, h5, h6 {
    font-family: 'Roboto', sans-serif;
    color: #353434;
    }

    /* --- NAVIGATION --- */
    .nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 60px;
      background: rgba(0, 0, 0, 0.97);
      backdrop-filter: blur(10px);
      z-index: 1000;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 24px;
      font-weight: 600;
      color: #ffffff;
      text-decoration: none;
    }

    .logo img {
      height: 24px;
      width: auto;
      margin-left: 160px;
    }

    .nav-links {
      display: flex;
      gap: 40px;
      align-items: center;
    }

    .nav-links a {
      color: #ffffff;
      text-decoration: none;
      font-size: 16px;
      transition: color 0.3s;
    }

    .nav-links a:hover {
      color: #00bcd4;
    }

    /* --- GREY BANNER --- */
    .banner {
      margin-top: 64px;
      color: #d4d4d4;
      text-align: left;
      padding: 60px 40px 60px 200px;
      height: 150px; /* Adjust this to control height */
      background-image: url('./pictures/PostHeaderBackground.png');
      background-size: cover; /* Stretches and crops to fill */
      background-position: center;
      background-repeat: no-repeat;
      display: flex;
    }

    .banner h1 {
      font-size: 40px;
      font-weight: 700;
      color: #d4d4d4;
    }

    /* --- ARTICLE SECTION --- */
    .article {
      background-color: #ffffff;
      max-width: 1000px;
      margin: 60px auto;
      padding: 40px 60px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      position: relative;
    }

    .article h2 {
      font-size: 28px;
      margin-bottom: 20px;
      margin-top: 20px;
      font-family: 'Lato', sans-serif;
    }

    .article p {
      line-height: 1.8;
      margin-bottom: 20px;
      color: #333;
    }

    .article code {
            font-family: 'Source Code Pro', Menlo, Consolas, monospace;
            font-size: 16px;
            background-color: #eeeeee;
            margin-left: 4px;
            margin-right: 4px;
            padding-left: 4px;
            padding-right: 4px;
            border-radius: 4px;
        }

    .article img {
      width: 100%;
      border-radius: 8px;
      margin: 20px 0;
    }

    .image-placeholder {
      width: 100%;
      height: 300px;
      border-radius: 8px;
      background: repeating-linear-gradient(
        45deg,
        #ccc,
        #ccc 10px,
        #ddd 10px,
        #ddd 20px
      );
      display: flex;
      align-items: center;
      justify-content: center;
      color: #555;
      font-size: 18px;
    }

    ul, ol {
            margin: 15px 0;
    }

    li {
            margin: 8px 0;
            margin-bottom: 16px;
            margin-left: 28px;
    }

    /* --- MkDocs Light+ inspired Prism style --- */
    pre[class*="language-"],
    code[class*="language-"] {
      font-family: 'Source Code Pro', Menlo, Consolas, monospace;
      background: #f8f8f8 !important;
      color: #2b2b2b;
      font-size: 15px;
      line-height: 1.5;
    }

    pre[class*="language-"] {
      padding: 12px 14px;
      margin: 1.2em 0;
      overflow-x: auto;
      border-radius: 4px;
      background: #f8f8f8 !important;
      position: relative;
    }

    :not(pre) > code[class*="language-"] {
      background: #f0f0f0;
      padding: 2px 4px;
      border-radius: 3px;
    }

    /* --- Light+ color palette --- */
    .token.comment {
      color: #af840f;
      font-style: italic;
    }
    .token.prolog,
    .token.doctype,
    .token.cdata {
      color: #6a9955;
      font-style: italic;
    }

    .token.keyword {
      color: #0000ff;
    }

    .token.string {
      color: #a31515;
    }

    .token.number {
      color: #098658;
    }

    .token.function {
      color: #795e26;
    }

    .token.class-name {
      color: #267f99;
    }

    .token.operator {
      color: #000000;
    }

    .token.punctuation {
      color: #393a34;
    }

    .token.variable {
      color: #001080;
    }

    /* --- Copy Button --- */
    .copy-button {
      position: absolute;
      top: 8px;
      right: 10px;
      background: #e0e0e0;
      color: #333;
      border: none;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 3px;
      cursor: pointer;
      opacity: 0.6;
      transition: opacity 0.2s, background 0.2s;
    }

    .copy-button:hover {
      opacity: 1;
      background: #d0d0d0;
    }

    @media (max-width: 768px) {
      .article {
        padding: 30px 20px;
      }
      .banner h1 {
        font-size: 30px;
      }
    }
  </style>
</head>

<body>
  <!-- NAVIGATION -->
  <nav class="nav">
    <a href="/" class="logo">
      <img src="../assets/Logo.png" alt="Quantstrip Logo" />
    </a>
    <div class="nav-links">
      <a href="#platform">Platform</a>
      <a href="#pricing">Pricing</a>
      <a href="#learn">Learn</a>
      <a href="login.html" class="sign-in">
        <svg
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
          <path d="M7 11V7a5 5 0 0 1 10 0v4" />
        </svg>
        Sign in
      </a>
    </div>
  </nav>

  <!-- GREY BANNER -->
  <section class="banner">
    <h1>Trading institutional flows at the end of month</h1>
  </section>

  <!-- WHITE ARTICLE AREA -->
  <section class="article">
       <h2>Overview</h2>
    <p>This trading client implements a systematic rebalancing strategy that capitalizes on end-of-month portfolio flows from wealth managers and institutional investors. As detailed in <a href="https://krislongmore.substack.com/p/how-wealth-managers-pay-you-to-trade" class="learn-more-link" target="_blank">Kris Longmore's analysis</a>, large asset managers typically rebalance their 60/40 stock-bond portfolios at month-end to maintain target allocations. This creates predictable selling pressure on the outperforming asset and buying pressure on the underperformer.</p>

    <p><strong>Strategy Logic:</strong></p>
    <ul>
        <li>On the 16th trading day of each month, identify which asset (SPY or TLT) has underperformed over the past 16 days</li>
        <li>Buy the underperformer with the full allocation</li>
        <li>Hold through month-end rebalancing flows</li>
        <li>Exit the position on the last trading day of the month</li>
    </ul>

    <p>The strategy anticipates that the underperforming asset will benefit from systematic buying as portfolio managers sell winners to buy losers, returning their portfolios to balanced allocations.</p>

    <hr>

    <h2>Part 1: General Setup</h2>

    <h3>Imports and Configuration</h3>

    <pre><button class="copy-button">Copy</button><code class="language-python">from quantstrip import ClientBase
import logging
from Utils import calendar_utils as cu
from IBKR.ib_objects import ib_order, ib_contract
from IBKR.ib_connect import ib</code></pre>

    <p>The implementation begins by importing the necessary Quantstrip components:</p>

    <ul>
        <li><code>ClientBase</code>: The foundation class from the Quantstrip module that handles client connectivity and task scheduling. By subclassing <code>ClientBase</code>, your strategy inherits all the connection management and scheduling infrastructure needed to run reliably.</li>
        
        <li><code>calendar_utils</code>: A utility module that provides trading calendar functions, eliminating the need to manually track business days across different exchanges.</li>
        
        <li><code>ib_objects</code> and <code>ib_connect</code>: Quantstrip's synchronous wrapper around Interactive Brokers' TWS API. Rather than wrestling with callback-based asynchronous code, these modules provide a clean, blocking interface that makes order placement and data retrieval straightforward.</li>
    </ul>

    <h3>Client Class Structure</h3>

    <pre><button class="copy-button">Copy</button><code class="language-python">ALLOCATION = 100000

class Client(ClientBase):
    """ A trading client executing the SPY/TLT rebalancing trade
    """
    def __init__(self, *args):
        super().__init__()
        self.display_name = "Rebalancing Flow"</code></pre>

    <p>The <code>Client</code> class extends <code>ClientBase</code>, inheriting the built-in scheduler and connection management. The <code>ALLOCATION</code> constant defines the dollar amount to deploy per trade ($100,000 in this example).</p>

    <p><strong>Scheduler Configuration:</strong><br>
    The inherited <code>self.scheduler</code> uses a simple, intuitive syntax for job scheduling.</p>

    <pre><button class="copy-button">Copy</button><code class="language-python">self.scheduler.every().day.at("15:45", "America/New_York").do(self.job)</code></pre>

    <p>This runs the strategy logic once daily at 3:45 PM ET, ensuring all trading logic is evaluated and orders are sent in time before market close.</p>

    <hr>

    <h2>Part 2: Entry Rule - Opening the Position</h2>

    <h3>Identifying the 16th Trading Day</h3>

    <pre><button class="copy-button">Copy</button><code class="language-python">if cu.business_day_number_today(calendar = "NYSE") == 16:</code></pre>

    <p>The entry logic triggers on the 16th trading day of each month using Quantstrip's <code>calendar_utils</code>. This function automatically accounts for weekends, holidays, and exchange-specific calendars—no need to maintain your own holiday databases or write complex date arithmetic.</p>

    <h3>Fetching Historical Data and Calculating Performance</h3>

    <pre><button class="copy-button">Copy</button><code class="language-python">with IB() as ib:
  # Get historical prices for last 16 days
  TLT = ib.get_historical_data(TLT_contract, "", "16 D", "1 day")
  SPY = ib.get_historical_data(SPY_contract, "", "16 D", "1 day")

  # Calculate performance
  TLT_perf    = TLT.iloc[0]["close"]/TLT.iloc[-1]["close"]
  TLT_qty     = ALLOCATION / TLT.iloc[0]["close"]

  SPY_perf    = SPY.iloc[0]["close"]/SPY.iloc[-1]["close"]
  SPY_qty     = ALLOCATION / SPY.iloc[0]["close"]
</code></pre>

    <p>The synchronous IB wrapper simplifies what would otherwise be complex asynchronous API calls:</p>

    <ol>
        <li><code>with IB() as ib</code>: Context manager that establishes connection to TWS/IB Gateway. The client ID for the connection is generated from a pool that recycles used IDs once connection is closed.</li>
        <li><code>ib.get_historical_data()</code>: Returns a pandas DataFrame with OHLC data—much easier to work with than raw API responses</li>
        <li><strong>Performance calculation</strong>: Simple ratio of latest close to first close gives the 16-day return</li>
        <li><strong>Position sizing</strong>: Calculates quantity based on the exit price (last close in the dataset)</li>
    </ol>

    <h3>Placing the Entry Order</h3>

    <pre><button class="copy-button">Copy</button><code class="language-python"># Open position
if TLT_perf > SPY_perf:
    contract, quantity = (SPY_contract, int(SPY_qty)) 
else:
    contract, quantity = (TLT_contract, int(TLT_qty))
    
ib.placeOrder(ib.get_next_order_id(), 
              contract, 
              ib_order(quantity, "Rebalancing", "MKT"))</code></pre>

    <p>The strategy selects the underperformer (if TLT outperformed, buy SPY; otherwise buy TLT) and places a market order. The <code>ib_order()</code> helper function constructs the order object with clean, readable parameters: quantity, tag for tracking ("Rebalancing"), and order type ("MKT").</p>

    <p><strong>Error Handling:</strong><br>
    The entire entry logic is wrapped in try-except-finally blocks, ensuring the IB connection is always properly closed via <code>ib.disconnect_client()</code>, even if an exception occurs.</p>

    <hr>

    <h2>Part 3: Exit Rule - Closing the Position</h2>

    <h3>Detecting Month-End</h3>

    <pre><button class="copy-button">Copy</button><code class="language-python">if cu.is_last_business_day_of_month(calendar = "NYSE"):</code></pre>

    <p>The exit trigger uses another calendar utility that identifies the last trading day of the month, accounting for the same holiday and weekend complexities.</p>

    <h3>Retrieving Current Positions and Exiting</h3>

    <pre><button class="copy-button">Copy</button><code class="language-python">if ib.connect_client(client_id = 1):
    positions = {p['contract'].symbol : p['position'] for p in ib.get_positions()} 
    logger.info(f"Positions {positions}")
    
    if "TLT" in positions:
        ib.placeOrder(ib.get_next_order_id(), 
                      TLT_contract, 
                      ib_order(-int(positions["TLT"]), "Rebalancing", "MKT"))
                      
    if "SPY" in positions: 
        ib.placeOrder(ib.get_next_order_id(), 
                      SPY_contract, 
                      ib_order(-int(positions["SPY"]), "Rebalancing", "MKT"))</code></pre>

    <p>The exit logic:</p>
    <ol>
        <li><strong>Fetches current positions</strong>: <code>ib.get_positions()</code> returns all open positions, which are converted to a dictionary mapping symbols to quantities</li>
        <li><strong>Checks for each symbol</strong>: Determines if either TLT or SPY is held</li>
        <li><strong>Places closing orders</strong>: For any held position, places a market order with negative quantity (selling the position)</li>
    </ol>

    <p>The same robust error handling ensures clean disconnection regardless of execution success.</p>

    <hr>

       <h2>Running the script</h2>
       <p>Open the Python editor and create a new file called "rebalancing_flow" in the Test folder. Paste the complete code into the editor and save it.</p>
      <figure>
        <img src="./pictures/python_editor.png" alt="TWS Configuration" style="max-width: 100%; height: auto;">
      </figure>
       <p>To simulate the client, you need to have the Interactive Brokers TWS or IB Gateway running and properly configured to accept API connections. 
       For testing purposes it is recommended to use the TWS to get visual confirmation that orders are placed as expected. The client will connect to the standard paper trading port (7497).
       
       <p>In test mode you typically want the client to run only once and then exit. You can do this by overriding the scheduler:</p> 
       <pre><code class="language-python">
#self.scheduler.every().day.at("15:45", "America/New_York").do(self.job)
self.scheduler.every(1).second.do(self.job)
      </code></pre>
        <p> At the end of the job function add the following line to stop the scheduler after one run:</p>
       <pre><code class="language-python">  self.stop_client()</code></pre>
        <p>This will make the client run the job once after one second and then exit.</p>


       <p>To force the opening and closing trades, replace the calendar utility functions with "True" in the if statements.</p>
        <pre><code class="language-python">
#if cu.business_day_number_today(calendar = "NYSE") == 16:
if True:
        </code></pre>
        <p>Overriding the entry rule by forcing it to "True" will create and send an order to open a position in the underperforming asset.</p>
        <figure>
        <img src="./pictures/TWS_entry_order.png" alt="TWS Configuration" style="max-width: 100%; height: auto;">
        </figure>
        <p>In live mode the client will run continuously, evaluating the job at the scheduled time each trading day.</p>

       <hr>

    <h2>Summary</h2>

    <p>This implementation demonstrates how Quantstrip streamlines systematic strategy development by providing:</p>
    <ul>
        <li>Reliable scheduling and connection management through <code>ClientBase</code></li>
        <li>Calendar-aware utilities that handle the complexities of trading day calculations</li>
        <li>A synchronous, Pythonic interface to Interactive Brokers that eliminates callback complexity</li>
    </ul>

    <p>The entire strategy—from scheduling to data retrieval to order placement—fits in under 70 lines of readable code. Whether you're implementing sophisticated quantitative strategies or simple rebalancing rules, Quantstrip's infrastructure lets you focus on strategy logic rather than plumbing.</p>
    <hr>

    <h2>Limitations</h2>
        <p>Though the script contains all the necessary parts to automate the rebalancing flow trading strategy, there are no internal revcords created that allows you to manage the trade-life cycle.
          This may be acceptable for a single trade strategy, but for more complex strategies it is recommended to implement proper trade management using Quantstrip's trade life-cycle datamodel.
        </p>
  </section>


  <!-- Copy to Clipboard Script -->
  <script>
    document.querySelectorAll('.copy-button').forEach((btn) => {
      btn.addEventListener('click', () => {
        const code = btn.nextElementSibling.innerText;
        navigator.clipboard.writeText(code).then(() => {
          btn.textContent = 'Copied!';
          setTimeout(() => (btn.textContent = 'Copy'), 1500);
        });
      });
    });
  </script>
</body>
</html>

